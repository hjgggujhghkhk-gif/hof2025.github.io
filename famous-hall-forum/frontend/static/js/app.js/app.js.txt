// APIÈÖçÁΩÆ
const API_BASE = 'http://localhost:5000/api';

// Áî®Êà∑ËÆ§ËØÅ
class Auth {
    static async login(username, password) {
        const response = await fetch(`${API_BASE}/login`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username, password})
        });
        return response.json();
    }

    static async register(username, password) {
        const response = await fetch(`${API_BASE}/register`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username, password})
        });
        return response.json();
    }
}

// Â∏ñÂ≠êÁÆ°ÁêÜ
class PostManager {
    static async loadPosts() {
        const response = await fetch(`${API_BASE}/posts`);
        const posts = await response.json();
        const postList = document.getElementById('postList');
        postList.innerHTML = posts.map(post => `
            <div class="post-card">
                <div class="post-header">
                    < img class="post-avatar" src="${post.avatar}" alt="Â§¥ÂÉè">
                    <div>
                        <h3>${post.title}</h3>
                        <small>by ${post.author}</small>
                    </div>
                </div>
                <p>${post.content}</p >
                ${post.images ? post.images.map(img => 
                    `< img src="${img}" style="max-width: 100%; margin: 0.5rem 0;" alt="Â∏ñÂ≠êÂõæÁâá">`
                ).join('') : ''}
                <div class="post-actions">
                    <button class="tip-btn" onclick="tipPost(${post.id})">
                        üí∞ ÊâìËµè (${post.tips})
                    </button>
                </div>
            </div>
        `).join('');
    }

    static async createPost(formData) {
        const response = await fetch(`${API_BASE}/posts`, {
            method: 'POST',
            body: formData
        });
        return response.json();
    }
}

// ÊâìËµèÂäüËÉΩ
async function tipPost(postId) {
    const amount = prompt('ËØ∑ËæìÂÖ•ÊâìËµèÈáëÈ¢ù:');
    if (amount && !isNaN(amount)) {
        const response = await fetch(`${API_BASE}/tip/${postId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({amount: parseFloat(amount)})
        });
        if (response.ok) {
            alert('ÊâìËµèÊàêÂäü!');
            PostManager.loadPosts();
            loadUserProfile();
        }
    }
}

// Áî®Êà∑ËµÑÊñôÂäüËÉΩ
function loadUserProfile() {
    console.log('Âä†ËΩΩÁî®Êà∑ËµÑÊñô');
}

function updateUserUI(user) {
    document.getElementById('username').textContent = user.username;
    document.getElementById('userAvatar').src = user.avatar;
    document.getElementById('totalTips').textContent = user.total_tips;
    const badgesContainer = document.getElementById('userBadges');
    badgesContainer.innerHTML = user.badges.map(badge => 
        `<span class="badge">${badge}</span>`
    ).join('');
}

// È°µÈù¢ÂàáÊç¢
function showSection(section) {
    document.querySelectorAll('section').forEach(s => s.style.display = 'none');
    document.getElementById(`${section}-section`).style.display = 'block';
    if (section === 'home') PostManager.loadPosts();
    if (section === 'profile') loadUserProfile();
}

// ÁôªÂΩïÊ®°ÊÄÅÊ°Ü
function showLogin() {
    document.getElementById('loginModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('loginModal').style.display = 'none';
}

function toggleAuth() {
    const authForm = document.getElementById('authForm');
    const submitButton = authForm.querySelector('button[type="submit"]');
    const toggleLink = authForm.querySelector('a');
    
    if (submitButton.textContent === 'ÁôªÂΩï') {
        submitButton.textContent = 'Ê≥®ÂÜå';
        toggleLink.textContent = 'Â∑≤ÊúâË¥¶Âè∑ÔºüÁ´ãÂç≥ÁôªÂΩï';
    } else {
        submitButton.textContent = 'ÁôªÂΩï';
        toggleLink.textContent = 'ËøòÊ≤°ÊúâË¥¶Âè∑ÔºüÁ´ãÂç≥Ê≥®ÂÜå';
    }
}

// ÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', () => {
    PostManager.loadPosts();

    document.querySelector('.close').addEventListener('click', closeModal);

    document.getElementById('authForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const username = formData.get('username');
        const password = formData.get('password');
        
        const isLogin = e.submitter.textContent === 'ÁôªÂΩï';
        let result;
        
        if (isLogin) {
            result = await Auth.login(username, password);
        } else {
            result = await Auth.register(username, password);
        }
        
        if (result.success) {
            localStorage.setItem('token', result.token);
            document.getElementById('loginModal').style.display = 'none';
            updateUserUI(result.user);
        }
    });

    document.getElementById('postForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        await PostManager.createPost(formData);
        e.target.reset();
        showSection('home');
    });
});